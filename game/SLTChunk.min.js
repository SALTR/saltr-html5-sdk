(function(l){var h=l.SALTR=l.SALTR||{};h.Chunk=function(c,a,d,b){this._layer=c;this._chunkCells=a;this._chunkAssetRules=d;this._availableCells=[];this._assetMap=b.assetsMap;this._stateMap=b.statesMap;this.generateCellContrent()};h.Utils.extend(h.Chunk.prototype,{generateCellContrent:function(){this._availableCells=this._chunkCells.concat();for(var c=[],a=[],d=[],b=0;b<this._chunkAssetRules.length;b++){var e=this._chunkAssetRules[b];switch(e.distributionType){case "count":c.push(e);break;case "ratio":a.push(e);
break;case "random":d.push(e)}}0<c.length&&this.generateAssetInstancesByCount(c);0<a.length?this.generateAssetInstancesByRatio(a):0<d.length&&this.generateAssetInstancesRandomly(d)},generateAssetInstances:function(c,a,d){a=this._assetMap[a];d=this._stateMap[d];for(var b,e,f=0;f<c&&(e=Math.round(Math.random()*this._availableCells.length-1),b=this._availableCells[e],b.setAssetInstance(this._layer.layerId,this._layer.layerIndex,new SLTAssetInstance(a.token,d,a.properties)),this._availableCells.splice(e,
1),0!=this._availableCells.length);f++);},generateAssetInstancesByCount:function(c){for(var a=0;a<c.length;a++){var d=c[a];this.generateAssetInstances(d.distributionValue,d.assetId,d.stateId)}},generateAssetInstancesByRatio:function(c){for(var a=0,d=c.length,b,e=0;e<d;++e)b=c[e],a+=b.distributionValue;var e=this._availableCells.length,f,k,g=[];if(0!=a){for(var h=0;h<d;h++)b=c[h],k=f=b.distributionValue/a*e,g.push({fraction:f-k,assetRule:b}),this.generateAssetInstances(k,b.assetId,b.stateId);g.sortOn("fraction",
Array.DESCENDING);e=_availableCells.length;for(c=0;c<e;c++)this.generateAssetInstances(1,g[c].assetRule.assetId,g[c].assetRule.stateId)}},generateAssetInstancesRandomly:function(c){var a=c.length,d=this._availableCells.length;if(0<a)for(var b=d>a?d/a:1,d=2>=b?1:b-2,b=1==b?1:b+2,e=a-1,f,k,g=0;g<a&&0<_availableCells.length;g++)f=c[g],k=g==e?this._availableCells.length:h.Utils.randomWithin(d,b),this.generateAssetInstances(k,f.assetId,f.stateId)}})})(window);
