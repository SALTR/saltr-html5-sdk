(function(l){var b=l.SALTR=l.SALTR||{};b.Saltr=function(a){b.EventDispatcher.apply(this);this._experiments=[];this._features={};this._levelPacks=[];this._saltrUserId="";this._connected=this._isLoading=!1;this._partner=null;this._instanceKey=a;this._onContentDataFail=this._onContentDataLoadSuccess=this._onAppDataLoadFail=this._onAppDataLoadSuccess=this._device=null;this._isInDevMode=!0;this._appVersion=""};l.SALTR=b;b.Saltr.prototype=new b.EventDispatcher;b.Utils.extend(b.Saltr.prototype,{initPartner:function(a,
c){this._partner=new b.Partner(a,c)},initDevice:function(a,c){this._device=new b.Device(a,c)},importLevelPacksFromJSON:function(a){a=JSON.parse(a);this._levelPacks=b.Deserialize.decodeLevels(a)},importLevelFromJSON:function(a,b){var d=JSON.parse(a);b.updateContent(d)},defineFeature:function(a,c){var d=this._features[a];d?d.defaultProperties=c:this._features[a]=new b.Feature(a,null,c)},start:function(a,c){var d=this;if(!this._isLoading){this._onAppDataLoadSuccess=a;this._onAppDataLoadFail=c;this._isLoading=
!0;this._connected=!1;var e=this.createAppDataResource();e.addEventListener(b.ResourceEvent.COMPLETE,function(a,b){e.dispose();d.appDataAssetLoadCompleteHandler(b)});e.addEventListener(b.ResourceEvent.ERROR,function(a,b){e.dispose();d.appDataAssetLoadErrorHandler(b)});e.load()}},createAppDataResource:function(){var a={};a.command=b.Config.COMMAND_APP_DATA;var c={};null!=this._device&&(c.device=this._device.getData());null!=this._partner&&(c.partner=this._partner.getData());c.instanceKey=this._instanceKey;
a.arguments=JSON.stringify(c);a=new b.ResourceTicket(b.Config.SALTR_API_URL,b.Utils.serializeURLVariables(a));return new b.Resource("saltAppConfig",a)},addUserProperty:function(a,c,d){for(var e=[],f={},h={},g=null,k=null,g=0;g<a.length;g++)e.push({key:a[g],value:c[g],operation:d[g]});f.saltId=this._saltrUserId;f.properties=e;f.instanceKey=this._instanceKey;h.command=b.Config.COMMAND_ADD_PROPERTY;h.arguments=JSON.stringify(f);g=new b.ResourceTicket(b.Config.SALTR_API_URL,h);k=new b.Resource("userProperty",
g);k.addEventListener(b.ResourceEvent.COMPLETE,function(a,b){k.dispose();this.addUserPropertyCompleteHandler(b)});k.addEventListener(b.ResourceEvent.ERROR,function(a,b){k.dispose();this.addUserPropertyErrorHandler(b)});k.load()},addUserPropertyCompleteHandler:function(a){},addUserPropertyErrorHandler:function(a){},appDataAssetLoadCompleteHandler:function(a){var c,d,e;a=a.responseData;this._isLoading=!1;this._connected=!0;this._saltrUserId=a.saltId||a.saltrUserId;this._experiments=b.Deserialize.decodeExperiments(a);
d=b.Deserialize.decodeFeatures(a);this._levelPacks=b.Deserialize.decodeLevels(a);for(c in d)if(d.hasOwnProperty(c)){a=d[c];if(e=this._features[c])a.defaultProperties=e.defaultProperties;this._features[c]=a}this._onAppDataLoadSuccess();this._isInDevMode&&this.syncFeatures()},appDataAssetLoadErrorHandler:function(a){this._onAppDataLoadFail(a)},syncFeatures:function(){var a={},c=this._features,d,e=[],f;a.command=b.Config.COMMAND_SAVE_OR_UPDATE_FEATURE;a.instanceKey=this._instanceKey;this._appVersion&&
(a.appVersion=this._appVersion);for(var h in c)c.hasOwnProperty(h)&&(d=c[h],d.defaultProperties&&e.push({token:d.token,value:JSON.stringify(d.defaultProperties)}));a.data=JSON.stringify(e);a=new b.ResourceTicket(b.Config.SALTR_URL,a);f=new b.Resource("saveOrUpdateFeature",a);f.addEventListener(b.ResourceEvent.COMPLETE,function(a,b){f.dispose();this.featureSyncCompleteHandler(b)});f.addEventListener(b.ResourceEvent.ERROR,function(a,b){f.dispose();this.featureSyncErrorHandler(b)});f.load()},featureSyncCompleteHandler:function(a){},
featureSyncErrorHandler:function(a){},loadLevelContentData:function(a,c,d){var e=this;this._onLevelLoadSuccess=c;this._onLevelLoadFail=d;c=a._contentDataUrl.replace(":8081",":8085");c=new b.ResourceTicket(c);var f=new b.Resource("loadLevel",c);f.addEventListener(b.ResourceEvent.COMPLETE,function(b,c){e.levelLoadCompleteHandler(a,c);f.dispose()});f.addEventListener(b.ResourceEvent.ERROR,function(a,b){e.levelLoadFailedHandler(b);f.dispose()});f.load()},levelLoadCompleteHandler:function(a,b){a.updateContent(b);
this._onLevelLoadSuccess()},levelLoadFailedHandler:function(a){console.error(a);this._onLevelLoadFail()}})})(window);
