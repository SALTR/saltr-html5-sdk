(function(m){var b=m.SALTR=m.SALTR||{};b.Saltr=function(a){b.EventDispatcher.apply(this);this._experiments=[];this._features={};this._levelPacks=[];this._saltrUserId="";this._connected=this._isLoading=!1;this._partner=null;this._clientKey=a;this._onContentDataFail=this._onContentDataLoadSuccess=this._onAppDataLoadFail=this._onAppDataLoadSuccess=this._device=null;this._isInDevMode=!0;this._appVersion=""};b.Saltr.prototype=new b.EventDispatcher;b.Utils.extend(b.Saltr.prototype,{appVersion:function(a){"undefined"!=
typeof a&&(this._appVersion=a);return this._appVersion},initPartner:function(a,c){this._partner=new b.Partner(a,c)},initDevice:function(a,c){this._device=new b.Device(a,c)},importLevelPacksFromJSON:function(a){a=JSON.parse(a);this._levelPacks=b.Deserializer.decodeLevels(a)},importLevelFromJSON:function(a,b){var e=JSON.parse(a);b.updateContent(e)},defineFeature:function(a,c){var e=this._features[a];e?e.defaultProperties(c):this._features[a]=new b.Feature(a,null,c)},start:function(a,c){var e=this;if(!this._isLoading){this._onAppDataLoadSuccess=
a;this._onAppDataLoadFail=c;this._isLoading=!0;this._connected=!1;var d=this.createAppDataResource();d.addEventListener(b.ResourceEvent.COMPLETE,function(a,b){d.dispose();e.appDataAssetLoadCompleteHandler(b)});d.addEventListener(b.ResourceEvent.ERROR,function(a,b){d.dispose();e.appDataAssetLoadErrorHandler(b)});d.load()}},createAppDataResource:function(){var a={},c={};this._device&&(a.device=this._device.getData());this._partner&&(a.partner=this._partner.getData());a.clientKey=this._clientKey;c.cmd=
b.Config.COMMAND_APP_DATA;c.args=JSON.stringify(a);a=new b.ResourceTicket(b.Config.SALTR_API_URL,b.Utils.serializeURLVariables(c));return new b.Resource("saltAppConfig",a)},addUserProperty:function(a,c,e){for(var d=this,f=[],k={},h={},g=null,l=null,g=0;g<a.length;g++)f.push({key:a[g],value:c[g],operation:e[g]});k.saltId=this._saltrUserId;k.properties=f;k.clientKey=this._clientKey;h.cmd=b.Config.COMMAND_ADD_PROPERTY;h.args=JSON.stringify(k);g=new b.ResourceTicket(b.Config.SALTR_API_URL,b.Utils.serializeURLVariables(h));
l=new b.Resource("userProperty",g);l.addEventListener(b.ResourceEvent.COMPLETE,function(a,b){l.dispose();d.addUserPropertyCompleteHandler(b)});l.addEventListener(b.ResourceEvent.ERROR,function(a,b){l.dispose();d.addUserPropertyErrorHandler(b)});l.load()},addUserPropertyCompleteHandler:function(a){},addUserPropertyErrorHandler:function(a){},appDataAssetLoadCompleteHandler:function(a){var c,e;a=a.responseData;this._isLoading=!1;this._connected=!0;this._saltrUserId=a.saltId||a.saltrUserId;this._experiments=
b.Deserializer.decodeExperiments(a);c=b.Deserializer.decodeFeatures(a);this._levelPacks=b.Deserializer.decodeLevels(a);for(var d in c)c.hasOwnProperty(d)&&(a=c[d],(e=this._features[d])&&a.defaultProperties(e.defaultProperties()),this._features[d]=a);this._onAppDataLoadSuccess();this._isInDevMode&&this.syncFeatures()},appDataAssetLoadErrorHandler:function(a){this._onAppDataLoadFail(a)},syncFeatures:function(){var a=this,c={},e=this._features,d,f=[],k={},h;this._appVersion&&(k.appVersion=this._appVersion);
k.clientKey=this._clientKey;for(var g in e)e.hasOwnProperty(g)&&(d=e[g],d.properties()&&f.push({token:d.token(),value:JSON.stringify(d.properties())}));k.developerFeatures=[f[0]];c.cmd=b.Config.COMMAND_SAVE_OR_UPDATE_FEATURE;c.args=JSON.stringify(k);c=new b.ResourceTicket(b.Config.SALTR_URL,b.Utils.serializeURLVariables(c));h=new b.Resource("saveOrUpdateFeature",c);h.addEventListener(b.ResourceEvent.COMPLETE,function(b,c){h.dispose();a.featureSyncCompleteHandler(c)});h.addEventListener(b.ResourceEvent.ERROR,
function(b,c){h.dispose();a.featureSyncErrorHandler(c)});h.load()},featureSyncCompleteHandler:function(a){debugger},featureSyncErrorHandler:function(a){},loadLevelContentData:function(a,c,e){var d=this;this._onLevelLoadSuccess=c;this._onLevelLoadFail=e;c=a._contentDataUrl.replace(":8081",":8085");c=new b.ResourceTicket(c);var f=new b.Resource("loadLevel",c);f.addEventListener(b.ResourceEvent.COMPLETE,function(b,c){d.levelLoadCompleteHandler(a,c);f.dispose()});f.addEventListener(b.ResourceEvent.ERROR,
function(a,b){d.levelLoadFailedHandler(b);f.dispose()});f.load()},levelLoadCompleteHandler:function(a,b){a.updateContent(b);this._onLevelLoadSuccess()},levelLoadFailedHandler:function(a){console.error(a);this._onLevelLoadFail()}})})(window);
